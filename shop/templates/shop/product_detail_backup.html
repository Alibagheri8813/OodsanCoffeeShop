{% extends 'shop/base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Premium Coffee Experience{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
{% endblock %}

{% block extra_css %}
<style>
    :root {
        /* Coffee Theme Color Palette - Matching Homepage */
        --primary-brown: #4B2E2B;
        --secondary-brown: #7B3F00;
        --accent-brown: #C97C5D;
        --coffee-cream: #FFF8F0;
        --coffee-gold: #F5DEB3;
        --coffee-light: #D2B48C;
        --coffee-dark: #2C1810;
        --coffee-beige: #F3E9DC;
        
        /* Gradients from Homepage */
        --gradient-primary: linear-gradient(135deg, #4B2E2B 0%, #7B3F00 50%, #C97C5D 100%);
        --gradient-gold: linear-gradient(135deg, #F5DEB3 0%, #D2B48C 50%, #8B4513 100%);
        --gradient-cream: linear-gradient(135deg, #FFF8F0 0%, #F3E9DC 100%);
        --gradient-accent: linear-gradient(135deg, #4B2E2B 0%, #7B3F00 100%);
        
        /* Shadows */
        --shadow-soft: 0 8px 25px rgba(75, 46, 43, 0.3);
        --shadow-medium: 0 15px 35px rgba(75, 46, 43, 0.4);
        --shadow-strong: 0 20px 50px rgba(75, 46, 43, 0.5);
        --shadow-glow: 0 0 30px rgba(245, 222, 179, 0.5);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Vazirmatn', 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #FFFFFF;
        color: var(--coffee-dark);
        line-height: 1.6;
        overflow-x: hidden;
    }

    /* Main content starts with proper top margin for base navbar */
    .main-content {
        margin-top: 0; /* Removed excessive margin - navbar is fixed positioned */
    }



    /* Beautiful Button Style from Home.html */
    .btn-primary, .btn, .add-to-cart-btn, .favorite-btn, .submit-btn, button[type="submit"], .checkout-btn, .update-btn, .remove-btn {
        display: inline-block;
        background: linear-gradient(135deg, #4B2E2B 0%, #7B3F00 100%);
        color: #FFF8F0;
        padding: 1rem 2.5rem;
        border-radius: 50px;
        text-decoration: none;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: 0 8px 25px rgba(75, 46, 43, 0.3);
        border: 2px solid transparent;
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

    .btn-primary::before, .btn::before, .add-to-cart-btn::before, .favorite-btn::before, .submit-btn::before, button[type="submit"]::before, .checkout-btn::before, .update-btn::before, .remove-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 248, 240, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .btn-primary:hover::before, .btn:hover::before, .add-to-cart-btn:hover::before, .favorite-btn:hover::before, .submit-btn:hover::before, button[type="submit"]:hover::before, .checkout-btn:hover::before, .update-btn:hover::before, .remove-btn:hover::before {
        left: 100%;
    }

    .btn-primary:hover, .btn:hover, .add-to-cart-btn:hover, .favorite-btn:hover, .submit-btn:hover, button[type="submit"]:hover, .checkout-btn:hover, .update-btn:hover, .remove-btn:hover {
        background: #FFF8F0;
        color: #4B2E2B;
        border-color: #4B2E2B;
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 15px 35px rgba(75, 46, 43, 0.4);
    }

    .btn-primary:active, .btn:active, .add-to-cart-btn:active, .favorite-btn:active, .submit-btn:active, button[type="submit"]:active, .checkout-btn:active, .update-btn:active, .remove-btn:active {
        transform: translateY(-1px) scale(1.02);
    }

    /* Add top margin to main content to account for fixed navbar */
    .product-detail-container {
        margin-top: 0; /* Removed excessive margin - navbar is fixed positioned */
        min-height: 100vh;
        padding: 2rem 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Coffee Steam Animation Background */
    .coffee-background {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: -1;
        opacity: 0.1;
    }

    .steam-particle {
        position: absolute;
        width: 4px;
        height: 30px;
        background: linear-gradient(to top, transparent, var(--coffee-cream), transparent);
        border-radius: 2px;
        animation: steam-rise 6s ease-in-out infinite;
    }

    .steam-particle:nth-child(1) { left: 10%; animation-delay: 0s; }
    .steam-particle:nth-child(2) { left: 20%; animation-delay: 1s; }
    .steam-particle:nth-child(3) { left: 70%; animation-delay: 2s; }
    .steam-particle:nth-child(4) { left: 85%; animation-delay: 3s; }

    @keyframes steam-rise {
        0% { 
            transform: translateY(100vh) scale(1); 
            opacity: 0; 
        }
        10% { 
            opacity: 0.3; 
        }
        90% { 
            opacity: 0.3; 
        }
        100% { 
            transform: translateY(-30px) scale(1.2); 
            opacity: 0; 
        }
    }

    /* Main Container */
    .product-detail-container {
        min-height: 100vh;
        padding: 2rem 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .product-wrapper {
        max-width: 1400px;
        width: 100%;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(20px);
        border-radius: 30px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: var(--shadow-strong);
        overflow: hidden;
        position: relative;
    }

    /* Coffee Bean Decorations */
    .coffee-beans::before,
    .coffee-beans::after {
        content: '☕';
        position: absolute;
        font-size: 2rem;
        color: var(--coffee-gold);
        opacity: 0.1;
        animation: float 8s ease-in-out infinite;
    }

    .coffee-beans::before {
        top: 10%;
        left: 5%;
        animation-delay: 0s;
    }

    .coffee-beans::after {
        bottom: 10%;
        right: 5%;
        animation-delay: 4s;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(0deg); }
        50% { transform: translateY(-20px) rotate(180deg); }
    }

    /* Product Header */
    .product-header {
        text-align: center;
        padding: 2rem;
        background: var(--gradient-accent);
        position: relative;
        overflow: hidden;
    }

    .product-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        animation: shimmer 3s ease-in-out infinite;
    }

    @keyframes shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }

    .product-header h1 {
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 2;
    }

    .category-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(255, 255, 255, 0.2);
        padding: 0.5rem 1rem;
        border-radius: 25px;
        font-size: 1rem;
        font-weight: 600;
        color: white;
        backdrop-filter: blur(10px);
        position: relative;
        z-index: 2;
    }

    /* Main Product Grid - IMAGE RIGHT, FEATURES LEFT */
    .product-main {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 3rem;
        padding: 3rem;
        align-items: start;
    }

    /* Left Side - Product Features & Info */
    .product-features {
        display: flex;
        flex-direction: column;
        gap: 2rem;
    }

    .product-title {
        font-size: 2rem;
        font-weight: 700;
        color: var(--coffee-dark);
        margin-bottom: 1rem;
        text-shadow: none;
    }

    .product-category {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: var(--gradient-gold);
        color: var(--coffee-dark);
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.9rem;
        width: fit-content;
        box-shadow: var(--shadow-soft);
    }

    /* Premium Price Display */
    .price-container {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        overflow: hidden;
    }

    .price-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--gradient-accent);
    }

    .product-price {
        font-size: 2rem;
        font-weight: 800;
        color: var(--coffee-gold);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    /* Stock Status */
    .stock-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border-radius: 15px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .stock-status.in-stock {
        background: rgba(76, 175, 80, 0.2);
        color: #4CAF50;
        border: 1px solid rgba(76, 175, 80, 0.3);
    }

    .stock-status.low-stock {
        background: rgba(255, 193, 7, 0.2);
        color: #FFC107;
        border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .stock-status.out-of-stock {
        background: rgba(244, 67, 54, 0.2);
        color: #F44336;
        border: 1px solid rgba(244, 67, 54, 0.3);
    }

    /* Product Description */
    .description-container {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .description-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--coffee-gold);
        margin-bottom: 1rem;
    }

    .product-description {
        color: var(--coffee-light);
        line-height: 1.8;
        font-size: 0.95rem;
    }

    /* Quantity and Actions */
    .product-actions {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .quantity-section {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .quantity-label {
        font-weight: 600;
        color: var(--coffee-dark);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.9rem;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .quantity-btn {
        background: transparent;
        border: none;
        color: var(--coffee-dark);
        padding: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .quantity-btn:hover {
        background: rgba(255, 255, 255, 0.1);
        color: var(--coffee-gold);
    }

    .quantity-input {
        background: transparent;
        border: none;
        color: var(--coffee-dark);
        text-align: center;
        width: 60px;
        padding: 0.75rem 0;
        font-size: 1rem;
        font-weight: 600;
    }

    .quantity-input:focus {
        outline: none;
        color: var(--coffee-gold);
    }

    /* Premium Add to Cart Button */
    .add-to-cart-btn {
        background: linear-gradient(135deg, var(--coffee-cream) 0%, #F5E6D3 100%);
        color: var(--primary-brown);
        border: none;
        padding: 1rem 2rem;
        border-radius: 15px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        box-shadow: var(--shadow-medium);
        position: relative;
        overflow: hidden;
    }

    .add-to-cart-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
        transition: left 0.5s ease;
    }

    .add-to-cart-btn:hover::before {
        left: 100%;
    }

    .add-to-cart-btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-strong), var(--shadow-glow);
    }

    .add-to-cart-btn:disabled {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.5);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
    }

    /* Social Actions */
    .social-actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .social-btn {
        background: linear-gradient(135deg, var(--coffee-cream) 0%, #F5E6D3 100%);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: var(--primary-brown);
        padding: 0.75rem 1rem;
        border-radius: 15px;
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .social-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-1px);
        box-shadow: var(--shadow-soft);
    }

    .social-btn.liked,
    .social-btn.favorited {
        background: var(--gradient-gold);
        color: var(--coffee-dark);
        border-color: var(--coffee-gold);
    }

    /* Right Side - Product Image */
    .product-image-side {
        display: flex;
        flex-direction: column;
        gap: 1.5rem;
    }

    .main-image-container {
        position: relative;
        border-radius: 25px;
        overflow: hidden;
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        box-shadow: var(--shadow-medium);
    }

    .main-image {
        width: 100%;
        height: 400px;
        object-fit: cover;
        transition: transform 0.5s ease;
    }

    .main-image:hover {
        transform: scale(1.05);
    }

    .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, transparent 30%, rgba(212, 175, 55, 0.1) 70%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .main-image-container:hover .image-overlay {
        opacity: 1;
    }

    /* Product Stats */
    .product-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }

    .stat-item {
        text-align: center;
        background: rgba(255, 255, 255, 0.05);
        padding: 1rem;
        border-radius: 15px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
    }

    .stat-number {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--coffee-gold);
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.8rem;
        color: var(--coffee-light);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.3rem;
    }

    /* Reviews Section */
    .reviews-section {
        margin-top: 3rem;
        padding: 2rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 20px;
        border-top: 3px solid var(--coffee-gold);
    }

    .reviews-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--coffee-gold);
        margin-bottom: 2rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .review-item {
        background: rgba(255, 255, 255, 0.05);
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .reviewer-name {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-weight: 600;
        color: var(--coffee-gold);
    }

    .review-date {
        display: flex;
        align-items: center;
        gap: 0.3rem;
        font-size: 0.8rem;
        color: var(--coffee-light);
    }

    .review-text {
        color: var(--coffee-cream);
        line-height: 1.6;
    }

    /* Comment Form */
    .comment-form {
        background: rgba(255, 255, 255, 0.05);
        padding: 2rem;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        margin-top: 2rem;
    }

    .comment-form h3 {
        color: var(--coffee-gold);
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .comment-textarea {
        width: 100%;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        padding: 1rem;
        color: var(--coffee-cream);
        font-family: inherit;
        resize: vertical;
        min-height: 120px;
        backdrop-filter: blur(10px);
    }

    .comment-textarea:focus {
        outline: none;
        border-color: var(--coffee-gold);
        box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
    }

    .comment-submit-btn {
        background: linear-gradient(135deg, var(--coffee-cream) 0%, #F5E6D3 100%);
        color: var(--primary-brown);
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 1rem;
    }

    .comment-submit-btn:hover {
        transform: translateY(-1px);
        box-shadow: var(--shadow-soft);
    }

    /* Related Products */
    .related-products {
        margin-top: 3rem;
        padding: 2rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 20px;
        border-top: 3px solid var(--coffee-orange);
    }

    .related-title {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--coffee-orange);
        margin-bottom: 2rem;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
    }

    .related-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
    }

    .related-item {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 15px;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .related-item:hover {
        transform: translateY(-5px);
        box-shadow: var(--shadow-medium);
        border-color: var(--coffee-orange);
    }

    .related-item-image {
        height: 150px;
        overflow: hidden;
    }

    .related-item-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

    .related-item:hover .related-item-image img {
        transform: scale(1.1);
    }

    .related-item-info {
        padding: 1rem;
    }

    .related-item-name {
        font-weight: 600;
        color: var(--coffee-cream);
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .related-item-price {
        color: var(--coffee-gold);
        font-weight: 700;
        font-size: 1rem;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
        .product-main {
            grid-template-columns: 1fr;
            gap: 2rem;
            padding: 2rem 1rem;
        }

        .product-image-side {
            order: -1; /* Image first on mobile */
        }

        .product-header h1 {
            font-size: 2rem;
        }

        .product-title {
            font-size: 1.5rem;
        }

        .product-price {
            font-size: 1.5rem;
        }

        .social-actions {
            grid-template-columns: 1fr;
        }

        .product-stats {
            grid-template-columns: repeat(2, 1fr);
        }

        .related-grid {
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }
    }

    /* Loading Animation */
    .pulse {
        animation: pulse 0.3s ease;
    }

    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }

    /* Notification Styles */
    #product-messages {
        margin-bottom: 1rem;
    }

    .alert {
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .alert-success {
        background: rgba(76, 175, 80, 0.2);
        color: #4CAF50;
        border: 1px solid rgba(76, 175, 80, 0.3);
    }

    .alert-error {
        background: rgba(244, 67, 54, 0.2);
        color: #F44336;
        border: 1px solid rgba(244, 67, 54, 0.3);
    }
</style>
{% endblock %}

{% block content %}


<!-- Coffee Steam Background -->
<div class="coffee-background">
    <div class="steam-particle"></div>
    <div class="steam-particle"></div>
    <div class="steam-particle"></div>
    <div class="steam-particle"></div>
</div>

<div class="product-detail-container">
    <div class="product-wrapper coffee-beans">
        <!-- Product Header -->
        <div class="product-header">
            <h1><i class="fas fa-coffee"></i> {{ product.name }}</h1>
            <div class="category-badge">
                <i class="fas fa-tag"></i> {{ product.category.name }}
            </div>
        </div>

        <!-- Main Product Grid -->
        <div class="product-main">
            <!-- LEFT SIDE - Product Features & Info -->
            <div class="product-features">
                <div id="product-messages"></div>
                
                <h2 class="product-title">{{ product.name }}</h2>
                
                <div class="product-category">
                    <i class="fas fa-layer-group"></i>
                    {{ product.category.name }}
                </div>
                
                <!-- Price Container -->
                <div class="price-container">
                    <div class="product-price">
                        <i class="fas fa-coins"></i>
                        {{ product.price|floatformat:0 }} تومان
                    </div>
                </div>
                
                <!-- Stock Status -->
                <div class="stock-status {% if product.stock > 10 %}in-stock{% elif product.stock > 0 %}low-stock{% else %}out-of-stock{% endif %}">
                    {% if product.stock > 10 %}
                        <i class="fas fa-check-circle"></i> موجود در انبار
                    {% elif product.stock > 0 %}
                        <i class="fas fa-exclamation-triangle"></i> کم موجودی ({{ product.stock }} عدد باقی‌مانده)
                    {% else %}
                        <i class="fas fa-times-circle"></i> ناموجود
                    {% endif %}
                </div>
                
                <!-- Description -->
                <div class="description-container">
                    <div class="description-title">
                        <i class="fas fa-info-circle"></i>
                        توضیحات محصول
                    </div>
                    <div class="product-description">{{ product.description }}</div>
                </div>
                
                <!-- Product Actions -->
                <div class="product-actions">
                    <div class="quantity-section">
                        <div class="quantity-label">
                            <i class="fas fa-sort-numeric-up"></i>
                            تعداد:
                        </div>
                        <div class="quantity-controls">
                            <button class="quantity-btn" onclick="changeQuantity(-1)" type="button">
                                <i class="fas fa-minus"></i>
                            </button>
                            <input type="number" id="quantity-input" class="quantity-input" value="1" min="1" max="{{ available_stock }}">
                            <button class="quantity-btn" onclick="changeQuantity(1)" type="button">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button id="add-to-cart-btn" class="add-to-cart-btn" onclick="addToCart()" {% if product.stock == 0 %}disabled{% endif %} type="button">
                        <i class="fas fa-shopping-cart"></i>
                        {% if product.stock == 0 %}
                            ناموجود
                        {% else %}
                            افزودن به سبد خرید
                        {% endif %}
                    </button>
                </div>
                
                <!-- Social Actions -->
                <div class="social-actions">
                    <button id="like-btn" class="social-btn like-btn {% if user_liked %}liked{% endif %}" onclick="toggleLike()" type="button">
                        <i class="fas fa-heart"></i>
                        <span id="like-count">{{ total_likes }}</span>
                        پسند
                    </button>
                    
                    <button id="favorite-btn" class="social-btn favorite-btn {% if user_favorited %}favorited{% endif %}" onclick="toggleFavorite()" type="button">
                        <i class="fas fa-star"></i>
                        <span id="favorite-count">{{ total_favorites }}</span>
                        علاقه‌مندی
                    </button>
                </div>
                
                <!-- Product Stats -->
                <div class="product-stats">
                    <div class="stat-item">
                        <div class="stat-number" id="stat-likes">{{ total_likes }}</div>
                        <div class="stat-label">
                            <i class="fas fa-heart"></i>
                            لایک
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="stat-favorites">{{ total_favorites }}</div>
                        <div class="stat-label">
                            <i class="fas fa-star"></i>
                            علاقه‌مندی
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="stat-reviews">{{ total_reviews }}</div>
                        <div class="stat-label">
                            <i class="fas fa-comment"></i>
                            نظر
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT SIDE - Product Image -->
            <div class="product-image-side">
                <div class="main-image-container">
                    {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="main-image">
                        <div class="image-overlay"></div>
                    {% else %}
                        <div style="width: 100%; height: 400px; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; color: var(--coffee-gold); font-size: 5rem;">
                            <i class="fas fa-coffee"></i>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="reviews-section">
            <h3 class="reviews-title">
                <i class="fas fa-star"></i>
                نظرات کاربران ({{ total_reviews }})
            </h3>
            
            {% if reviews %}
                {% for review in reviews %}
                <div class="review-item">
                    <div class="review-header">
                        <span class="reviewer-name">
                            <i class="fas fa-user-circle"></i>
                            {{ review.user.username }}
                        </span>
                        <span class="review-date">
                            <i class="fas fa-calendar-alt"></i>
                            {{ review.created_at|date:"Y/m/d" }}
                        </span>
                    </div>
                    <p class="review-text">{{ review.text }}</p>
                </div>
                {% endfor %}
            {% else %}
                <div style="text-align: center; padding: 3rem; color: rgba(255, 255, 255, 0.6);">
                    <i class="fas fa-comment-slash" style="font-size: 3rem; margin-bottom: 1rem; color: var(--coffee-gold);"></i>
                    <h3 style="color: var(--coffee-cream); margin-bottom: 0.5rem;">هنوز نظری ثبت نشده</h3>
                    <p>اولین نفری باشید که نظر خود را درباره این محصول ثبت می‌کند</p>
                </div>
            {% endif %}
            
            <!-- Comment Form -->
            {% if user.is_authenticated %}
            <div class="comment-form">
                <h3>
                    <i class="fas fa-pen"></i>
                    نظر خود را بنویسید
                </h3>
                <form method="post">
                    {% csrf_token %}
                    <textarea name="text" class="comment-textarea" placeholder="نظر خود را در مورد این محصول بنویسید..." required></textarea>
                    <button type="submit" class="comment-submit-btn">
                        <i class="fas fa-paper-plane"></i>
                        ثبت نظر
                    </button>
                </form>
            </div>
            {% else %}
            <div class="comment-form">
                <h3>
                    <i class="fas fa-sign-in-alt"></i>
                    برای ثبت نظر وارد شوید
                </h3>
                <p style="color: var(--coffee-light); margin-bottom: 1rem;">
                    برای ثبت نظر در مورد این محصول، لطفاً وارد حساب کاربری خود شوید.
                </p>
                <div style="display: flex; gap: 1rem;">
                    <a href="{% url 'login' %}" class="comment-submit-btn" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-sign-in-alt"></i>
                        ورود
                    </a>
                    <a href="{% url 'signup' %}" class="comment-submit-btn" style="text-decoration: none; display: inline-flex; align-items: center; gap: 0.5rem; background: var(--gradient-accent); color: white;">
                        <i class="fas fa-user-plus"></i>
                        ثبت نام
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Related Products -->
        {% if related_products %}
        <div class="related-products">
            <h3 class="related-title">
                <i class="fas fa-sparkles"></i>
                محصولات مرتبط
            </h3>
            <div class="related-grid">
                {% for related in related_products %}
                <div class="related-item" onclick="location.href='{% url 'product_detail' related.id %}'">
                    <div class="related-item-image">
                        {% if related.image %}
                            <img src="{{ related.image.url }}" alt="{{ related.name }}">
                        {% else %}
                            <div style="width: 100%; height: 100%; background: var(--gradient-primary); display: flex; align-items: center; justify-content: center; color: var(--coffee-gold); font-size: 2rem;">
                                <i class="fas fa-coffee"></i>
                            </div>
                        {% endif %}
                    </div>
                    <div class="related-item-info">
                        <div class="related-item-name">{{ related.name }}</div>
                        <div class="related-item-price">{{ related.price|floatformat:0 }} تومان</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
const productId = {{ product.id }};
let currentQuantity = 1;
const maxStock = {{ available_stock }};

function changeQuantity(delta) {
    const input = document.getElementById('quantity-input');
    let newValue = currentQuantity + delta;
    
    if (newValue < 1) newValue = 1;
    if (newValue > maxStock) newValue = maxStock;
    
    currentQuantity = newValue;
    input.value = newValue;
    
    // Add visual feedback
    input.classList.add('pulse');
    setTimeout(() => input.classList.remove('pulse'), 300);
}

function addToCart() {
    const btn = document.getElementById('add-to-cart-btn');
    const originalText = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال افزودن...';
    btn.disabled = true;
    
    fetch('{% url "add_to_cart" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            product_id: productId,
            quantity: currentQuantity
        })
    })
    .then(response => response.json())
    .then(data => {
        const messagesDiv = document.getElementById('product-messages');
        
        if (data.success) {
            messagesDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle"></i>
                    ${data.message}
                </div>
            `;
            // Update cart count if element exists
            const cartCount = document.getElementById('cartCount');
            if (cartCount) {
                cartCount.textContent = data.cart_count || '';
            }
        } else {
            messagesDiv.innerHTML = `
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-circle"></i>
                    ${data.message}
                </div>
            `;
            if (data.redirect) {
                setTimeout(() => window.location.href = data.redirect, 1500);
            }
        }
        
        // Remove message after 5 seconds
        setTimeout(() => {
            messagesDiv.innerHTML = '';
        }, 5000);
    })
    .catch(error => {
        console.error('Error:', error);
        const messagesDiv = document.getElementById('product-messages');
        messagesDiv.innerHTML = `
            <div class="alert alert-error">
                <i class="fas fa-exclamation-circle"></i>
                خطا در افزودن به سبد خرید
            </div>
        `;
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function toggleLike() {
    {% if not user.is_authenticated %}
        window.location.href = '{% url "login" %}';
        return;
    {% endif %}
    
    const btn = document.getElementById('like-btn');
    const countSpan = document.getElementById('like-count');
    const statLikes = document.getElementById('stat-likes');
    
    fetch('{% url "toggle_like" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            product_id: productId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.is_liked) {
                btn.classList.add('liked');
                btn.querySelector('i').className = 'fas fa-heart';
            } else {
                btn.classList.remove('liked');
                btn.querySelector('i').className = 'far fa-heart';
            }
            countSpan.textContent = data.total_likes;
            statLikes.textContent = data.total_likes;
        } else {
            const messagesDiv = document.getElementById('product-messages');
            messagesDiv.innerHTML = `
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-circle"></i>
                    ${data.message}
                </div>
            `;
            if (data.redirect) {
                setTimeout(() => window.location.href = data.redirect, 1500);
            }
        }
    })
    .catch(error => console.error('Error:', error));
}

function toggleFavorite() {
    {% if not user.is_authenticated %}
        window.location.href = '{% url "login" %}';
        return;
    {% endif %}
    
    const btn = document.getElementById('favorite-btn');
    const countSpan = document.getElementById('favorite-count');
    const statFavorites = document.getElementById('stat-favorites');
    
    fetch('{% url "toggle_favorite" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            product_id: productId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.is_favorited) {
                btn.classList.add('favorited');
                btn.querySelector('i').className = 'fas fa-star';
            } else {
                btn.classList.remove('favorited');
                btn.querySelector('i').className = 'far fa-star';
            }
            countSpan.textContent = data.total_favorites;
            statFavorites.textContent = data.total_favorites;
        } else {
            const messagesDiv = document.getElementById('product-messages');
            messagesDiv.innerHTML = `
                <div class="alert alert-error">
                    <i class="fas fa-exclamation-circle"></i>
                    ${data.message}
                </div>
            `;
            if (data.redirect) {
                setTimeout(() => window.location.href = data.redirect, 1500);
            }
        }
    })
    .catch(error => console.error('Error:', error));
}

// Update quantity input listener
document.getElementById('quantity-input').addEventListener('change', function() {
    let value = parseInt(this.value);
    if (value < 1) value = 1;
    if (value > maxStock) value = maxStock;
    currentQuantity = value;
    this.value = value;
});

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Add entrance animations
    const elements = document.querySelectorAll('.product-features > *, .product-image-side > *');
    elements.forEach((el, index) => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        setTimeout(() => {
            el.style.transition = 'all 0.6s ease';
            el.style.opacity = '1';
            el.style.transform = 'translateY(0)';
        }, index * 100);
    });
});

// Dropdown functionality
function toggleHeroDropdown() {
    const dropdown = document.getElementById('heroProfileDropdown');
    dropdown.classList.toggle('show');
}

// Close dropdown when clicking outside
document.addEventListener('click', function(event) {
    const dropdown = document.getElementById('heroProfileDropdown');
    const toggle = document.querySelector('.hero-dropdown-toggle');
    
    if (dropdown && !dropdown.contains(event.target) && !toggle.contains(event.target)) {
        dropdown.classList.remove('show');
    }
});
</script>
{% endblock %} 