{% extends 'shop/base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Premium Coffee Experience{% endblock %}
{% block meta_description %}خرید {{ product.name }} با عطر و طعم بی‌نظیر. وزن‌ها و آسیاب‌های مختلف، ارسال سریع.{% endblock %}
{% block og_title %}{{ product.name }}{% endblock %}
{% block og_description %}{{ product.description|truncatechars:160 }}{% endblock %}
{% block og_image %}{% if product.image %}{{ product.image.url }}{% else %}{% static 'shop/images/coffee-shop-og.jpg' %}{% endif %}{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js" defer></script>
{% endblock %}

{% block extra_css %}
<style>
    :root {
        /* Coffee Theme Color Palette - Matching Homepage */
        --primary-brown: #4B2E2B;
        --secondary-brown: #7B3F00;
        --accent-brown: #C97C5D;
        --coffee-cream: #FFF8F0;
        --coffee-gold: #F5DEB3;
        --coffee-light: #D2B48C;
        --coffee-dark: #2C1810;
        --coffee-beige: #F3E9DC;
        
        /* Gradients from Homepage */
        --gradient-primary: linear-gradient(135deg, #4B2E2B 0%, #7B3F00 50%, #C97C5D 100%);
        --gradient-gold: linear-gradient(135deg, #F5DEB3 0%, #D2B48C 50%, #8B4513 100%);
        --gradient-cream: linear-gradient(135deg, #FFF8F0 0%, #F3E9DC 100%);
        --gradient-accent: linear-gradient(135deg, #4B2E2B 0%, #7B3F00 100%);
        --gradient-magical: linear-gradient(45deg, #F5DEB3, #D2B48C, #8B4513, #D2B48C, #F5DEB3);
        
        /* Shadows */
        --shadow-soft: 0 8px 25px rgba(75, 46, 43, 0.3);
        --shadow-medium: 0 15px 35px rgba(75, 46, 43, 0.4);
        --shadow-strong: 0 20px 50px rgba(75, 46, 43, 0.5);
        --shadow-glow: 0 0 30px rgba(245, 222, 179, 0.5);
        --shadow-magical: 0 0 40px rgba(245, 222, 179, 0.8);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Vazirmatn', sans-serif;
        background: var(--gradient-cream);
        color: var(--coffee-dark);
        line-height: 1.6;
        overflow-x: hidden;
    }

    /* Sensational Background with Floating Elements */
    .product-detail-container {
        min-height: 100vh;
        padding: 0.8rem;
        background: var(--gradient-cream);
        position: relative;
        overflow: hidden;
    }

    /* Coffee Bean Floating Animation - From Homepage */
    .floating-beans {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
        opacity: 0.3;
    }

    .bean {
        position: absolute;
        width: 12px;
        height: 12px;
        background: var(--gradient-gold);
        border-radius: 50%;
        animation: floatBean 20s infinite linear;
        box-shadow: var(--shadow-glow);
    }

    .bean:nth-child(1) { left: 5%; animation-delay: 0s; }
    .bean:nth-child(2) { left: 15%; animation-delay: 4s; }
    .bean:nth-child(3) { left: 30%; animation-delay: 8s; }
    .bean:nth-child(4) { left: 45%; animation-delay: 12s; }
    .bean:nth-child(5) { left: 60%; animation-delay: 16s; }
    .bean:nth-child(6) { left: 75%; animation-delay: 2s; }
    .bean:nth-child(7) { left: 85%; animation-delay: 6s; }
    .bean:nth-child(8) { left: 95%; animation-delay: 10s; }

    @keyframes floatBean {
        0% {
            transform: translateY(100vh) rotate(0deg) scale(0.5);
            opacity: 0;
        }
        10% {
            opacity: 0.6;
            transform: translateY(90vh) rotate(36deg) scale(1);
        }
        90% {
            opacity: 0.6;
            transform: translateY(10vh) rotate(324deg) scale(1);
        }
        100% {
            transform: translateY(-10vh) rotate(360deg) scale(0.5);
            opacity: 0;
        }
    }

    /* Improved Main Product Grid - Better Responsive Layout */
    .product-main-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        max-width: 1200px;
        margin: 0 auto;
        position: relative;
        z-index: 10;
        padding: 1rem;
        align-items: start;
    }

    /* Left Side - Product Information - Better Spacing */
    .product-info-side {
        display: flex;
        flex-direction: column;
        gap: 1.2rem;
        animation: slideInLeft 1s ease-out;
        padding: 0.5rem;
    }

    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-50px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* Product Title with Magical Effect - Smaller */
    .product-title {
        font-size: 1.4rem;
        font-weight: 900;
        background: var(--gradient-magical);
        background-size: 400% 400%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: gradient-shift 4s ease-in-out infinite, float-title 6s ease-in-out infinite;
        text-shadow: 0 0 30px rgba(245, 222, 179, 0.3);
        margin-bottom: 0.2rem;
        line-height: 1.2;
    }

    @keyframes gradient-shift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }

    @keyframes float-title {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-3px); }
    }

    /* Product Description - More Compact */
    .product-description {
        background: rgba(255, 248, 240, 0.9);
        padding: 0.7rem;
        border-radius: 12px;
        border: 2px solid rgba(245, 222, 179, 0.3);
        box-shadow: var(--shadow-soft);
        font-size: 0.85rem;
        line-height: 1.4;
        color: var(--primary-brown);
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
    }

    .product-description:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
        border-color: var(--coffee-gold);
    }

    /* Price Display with Animation - Smaller */
    .price-container {
        background: var(--gradient-accent);
        padding: 0.7rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: var(--shadow-medium);
        position: relative;
        overflow: hidden;
        animation: pulse-glow 3s ease-in-out infinite;
    }

    @keyframes pulse-glow {
        0%, 100% { 
            box-shadow: var(--shadow-medium);
        }
        50% { 
            box-shadow: var(--shadow-strong), var(--shadow-magical);
        }
    }

    .price-label {
        color: var(--coffee-cream);
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 0.2rem;
        opacity: 0.9;
    }

    .price-amount {
        color: var(--coffee-cream);
        font-size: 1.3rem;
        font-weight: 900;
        text-shadow: 0 0 20px rgba(255, 248, 240, 0.5);
    }

    .price-currency {
        font-size: 1rem;
        margin-right: 0.4rem;
    }

    /* Sensational Dropdown Styles - More Compact */
    .options-container {
        z-index: 10000000000000000 ;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.6rem;
        margin: 0.6rem 0;
    }

    .option-group {
        background: rgba(255, 248, 240, 0.95);
        border-radius: 10px;
        padding: 0.6rem;
        border: 2px solid rgba(245, 222, 179, 0.3);
        box-shadow: var(--shadow-soft);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        backdrop-filter: blur(10px);
        position: relative; /* Ensure stacking context positioning */
        z-index: 2; /* Bring dropdown group above quantity container */
    }

    .option-group:hover {
        transform: translateY(-3px) scale(1.01);
        box-shadow: var(--shadow-medium), var(--shadow-glow);
        border-color: var(--coffee-gold);
    }

    .option-label {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--primary-brown);
        margin-bottom: 0.6rem;
    }

    .option-label i {
        font-size: 1rem;
        color: var(--secondary-brown);
    }

    /* Custom Dropdown Styling */
    .custom-select {
        position: relative;
        width: 100%;
    }

    .select-display {
        background: var(--gradient-cream);
        border: 2px solid rgba(75, 46, 43, 0.2);
        border-radius: 10px;
        padding: 0.6rem 0.8rem;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--primary-brown);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow-soft);
        position: relative;
        overflow: hidden;
    }

    .select-display::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(245, 222, 179, 0.3), transparent);
        transition: left 0.5s ease;
    }

    .select-display:hover::before {
        left: 100%;
    }

    .select-display:hover {
        border-color: var(--secondary-brown);
        transform: translateY(-1px);
        box-shadow: var(--shadow-medium);
    }

    .select-display.open {
        border-color: var(--secondary-brown);
        box-shadow: var(--shadow-glow);
    }

    .select-arrow {
        transition: transform 0.3s ease;
        color: var(--secondary-brown);
        font-size: 1rem;
    }

    .select-display.open .select-arrow {
        transform: rotate(180deg);
    }

    /* Original select-options styles moved to z-index fix section above */

    .select-option {
        padding: 0.6rem 0.8rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 1px solid rgba(245, 222, 179, 0.2);
        color: var(--primary-brown);
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.8rem;
    }

    .select-option:last-child {
        border-bottom: none;
    }

    .select-option:hover {
        background: var(--gradient-gold);
        color: var(--primary-brown);
        transform: translateX(3px);
    }

    .select-option.selected {
        background: var(--gradient-accent);
        color: var(--coffee-cream);
        font-weight: 700;
    }

    /* Make inner text non-interactive so clicks target the option container */
    .select-option span { pointer-events: none; }

    .option-price {
        font-size: 0.8rem;
        font-weight: 700;
        color: var(--secondary-brown);
    }

    /* Quantity Selector - More Compact */
    .quantity-container {
        background: rgba(255, 248, 240, 0.95);
        border-radius: 10px;
        padding: 0.6rem;
        border: 2px solid rgba(245, 222, 179, 0.3);
        box-shadow: var(--shadow-soft);
        text-align: center;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
    }

    .quantity-container:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
        border-color: var(--coffee-gold);
    }

    .quantity-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.4rem;
        font-size: 0.85rem;
        font-weight: 700;
        color: var(--primary-brown);
        margin-bottom: 0.6rem;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
        background: var(--gradient-cream);
        border-radius: 30px;
        padding: 0.2rem;
        box-shadow: inset 0 2px 10px rgba(75, 46, 43, 0.1);
    }

    .quantity-btn {
        width: 32px;
        height: 32px;
        border: none;
        background: var(--gradient-accent);
        color: var(--coffee-cream);
        border-radius: 50%;
        font-size: 1rem;
        font-weight: 900;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: var(--shadow-soft);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .quantity-btn:hover {
        background: var(--gradient-gold);
        color: var(--primary-brown);
        transform: scale(1.1);
        box-shadow: var(--shadow-medium);
    }

    .quantity-btn:active {
        transform: scale(0.95);
    }

    .quantity-input {
        width: 50px;
        height: 32px;
        border: 2px solid rgba(75, 46, 43, 0.2);
        border-radius: 10px;
        text-align: center;
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--primary-brown);
        background: var(--coffee-cream);
        box-shadow: inset 0 2px 5px rgba(75, 46, 43, 0.1);
    }

    .quantity-input:focus {
        outline: none;
        border-color: var(--secondary-brown);
        box-shadow: var(--shadow-glow);
    }

    /* Sensational Action Buttons - More Compact */
    .action-buttons {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 0.6rem;
        margin: 0.8rem 0;
    }

    /* Add to Cart Button - Hero Style */
    .add-to-cart-btn {
        background: var(--gradient-accent);
        color: var(--coffee-cream);
        border: none;
        padding: 0.7rem 1rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 900;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: var(--shadow-medium);
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        animation: cart-pulse 2s ease-in-out infinite;
    }

    @keyframes cart-pulse {
        0%, 100% { 
            box-shadow: var(--shadow-medium);
        }
        50% { 
            box-shadow: var(--shadow-strong), var(--shadow-magical);
        }
    }

    .add-to-cart-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 248, 240, 0.3), transparent);
        transition: left 0.6s ease;
    }

    .add-to-cart-btn:hover::before {
        left: 100%;
    }

    .add-to-cart-btn:hover {
        background: var(--gradient-gold);
        color: var(--primary-brown);
        transform: translateY(-3px) scale(1.03);
        box-shadow: var(--shadow-strong), var(--shadow-magical);
    }

    .add-to-cart-btn:active {
        transform: translateY(-1px) scale(1.01);
    }

    .add-to-cart-btn i {
        font-size: 1.2rem;
        animation: cart-bounce 1s ease-in-out infinite;
    }

    @keyframes cart-bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-2px); }
    }

    /* Like and Favorite Buttons - Smaller */
    .social-btn {
        background: rgba(255, 248, 240, 0.9);
        border: 2px solid rgba(245, 222, 179, 0.3);
        color: var(--primary-brown);
        padding: 0.7rem;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: var(--shadow-soft);
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
        backdrop-filter: blur(10px);
    }

    .social-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(245, 222, 179, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .social-btn:hover::before {
        left: 100%;
    }

    .social-btn:hover {
        background: var(--gradient-gold);
        border-color: var(--secondary-brown);
        transform: translateY(-3px) scale(1.03);
        box-shadow: var(--shadow-medium), var(--shadow-glow);
    }

    .social-btn.liked {
        background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
        color: white;
        border-color: #FF6B6B;
        animation: heart-beat 1.5s ease-in-out infinite;
    }

    @keyframes heart-beat {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.03); }
    }

    .social-btn.favorited {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: var(--coffee-dark);
        border-color: #FFD700;
        animation: star-twinkle 2s ease-in-out infinite;
    }

    @keyframes star-twinkle {
        0%, 100% { 
            box-shadow: var(--shadow-soft);
        }
        50% { 
            box-shadow: var(--shadow-medium), 0 0 30px rgba(255, 215, 0, 0.8);
        }
    }

    /* Right Side - Product Image - Smaller */
    .product-image-side {
        display: flex;
        flex-direction: column;
        gap: 0.7rem;
        animation: slideInRight 1s ease-out;
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(50px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* Main Image Container with Magical Effects - Smaller */
    .main-image-container {
        position: relative;
        border-radius: 15px;
        overflow: hidden;
        background: var(--gradient-cream);
        border: 2px solid rgba(245, 222, 179, 0.3);
        box-shadow: var(--shadow-medium);
        transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        cursor: pointer;
    }

    .main-image-container:hover {
        transform: translateY(-5px) scale(1.01);
        box-shadow: var(--shadow-strong), var(--shadow-magical);
        border-color: var(--coffee-gold);
    }

    .main-image {
        width: 100%;
        height: 350px;
        object-fit: cover;
        transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .main-image:hover {
        transform: scale(1.05);
    }

    /* Magical Image Overlay */
    .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 30% 30%, rgba(245, 222, 179, 0.2) 0%, transparent 50%),
            radial-gradient(circle at 70% 70%, rgba(210, 180, 140, 0.2) 0%, transparent 50%),
            linear-gradient(45deg, transparent 30%, rgba(245, 222, 179, 0.1) 70%);
        opacity: 0;
        transition: opacity 0.5s ease;
        pointer-events: none;
    }

    .main-image-container:hover .image-overlay {
        opacity: 1;
    }

    /* Steam Effect on Image */
    .steam-effect {
        position: absolute;
        top: 20%;
        left: 50%;
        transform: translateX(-50%);
        width: 80px;
        height: 150px;
        background: linear-gradient(180deg, transparent, rgba(245, 222, 179, 0.3), transparent);
        filter: blur(12px);
        opacity: 0;
        animation: steam-rise-image 4s ease-in-out infinite;
        pointer-events: none;
    }

    @keyframes steam-rise-image {
        0% {
            opacity: 0;
            transform: translateX(-50%) translateY(0) scaleY(0.5);
        }
        50% {
            opacity: 0.6;
            transform: translateX(-50%) translateY(-40px) scaleY(1.3) scaleX(1.1);
        }
        100% {
            opacity: 0;
            transform: translateX(-50%) translateY(-80px) scaleY(1.8) scaleX(1.3);
        }
    }

    .main-image-container:hover .steam-effect {
        opacity: 1;
    }

    /* Product Stats with Beautiful Animation - Smaller */
    .product-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.4rem;
        margin-top: 0.6rem;
    }

    .stat-item {
        text-align: center;
        background: rgba(255, 248, 240, 0.95);
        padding: 0.6rem 0.3rem;
        border-radius: 12px;
        border: 2px solid rgba(245, 222, 179, 0.3);
        box-shadow: var(--shadow-soft);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .stat-item::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: conic-gradient(transparent, rgba(245, 222, 179, 0.1), transparent);
        animation: rotate-bg 4s linear infinite;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .stat-item:hover::before {
        opacity: 1;
    }

    @keyframes rotate-bg {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .stat-item:hover {
        transform: translateY(-5px) scale(1.03);
        box-shadow: var(--shadow-medium), var(--shadow-glow);
        border-color: var(--coffee-gold);
    }

    .stat-number {
        font-size: 1.2rem;
        font-weight: 900;
        background: var(--gradient-accent);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.1rem;
        position: relative;
        z-index: 2;
    }

    .stat-label {
        font-size: 0.7rem;
        color: var(--primary-brown);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.15rem;
        font-weight: 600;
        position: relative;
        z-index: 2;
    }

    .stat-label i {
        font-size: 0.8rem;
        color: var(--secondary-brown);
    }

    /* Comments Section */
    .comments-section {
        max-width: 1200px;
        margin: 3rem auto 2rem;
        padding: 0 1rem;
        position: relative;
        z-index: 10;
    }

    .comments-header {
        background: var(--gradient-accent);
        color: var(--coffee-cream);
        padding: 1rem;
        border-radius: 15px 15px 0 0;
        text-align: center;
        margin-bottom: 0;
        box-shadow: var(--shadow-medium);
    }

    .comments-header h3 {
        font-size: 1.2rem;
        font-weight: 900;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.6rem;
    }

    .comments-container {
        background: rgba(255, 248, 240, 0.95);
        border: 2px solid rgba(245, 222, 179, 0.3);
        border-radius: 0 0 15px 15px;
        padding: 1.5rem;
        backdrop-filter: blur(10px);
        box-shadow: var(--shadow-medium);
    }

    .comment-form {
        margin-bottom: 1.5rem;
        padding-bottom: 1.5rem;
        border-bottom: 2px solid rgba(245, 222, 179, 0.3);
    }

    .comment-form textarea {
        width: 100%;
        min-height: 80px;
        padding: 0.8rem;
        border: 2px solid rgba(75, 46, 43, 0.2);
        border-radius: 12px;
        background: var(--coffee-cream);
        color: var(--primary-brown);
        font-family: 'Vazirmatn', sans-serif;
        font-size: 0.9rem;
        line-height: 1.5;
        resize: vertical;
        transition: all 0.3s ease;
        box-shadow: var(--shadow-soft);
    }

    .comment-form textarea:focus {
        outline: none;
        border-color: var(--secondary-brown);
        box-shadow: var(--shadow-glow);
    }

    .comment-form textarea::placeholder {
        color: rgba(75, 46, 43, 0.6);
    }

    .comment-submit-btn {
        background: var(--gradient-accent);
        color: var(--coffee-cream);
        border: none;
        padding: 0.8rem 1.5rem;
        border-radius: 12px;
        font-size: 0.9rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: var(--shadow-medium);
        margin-top: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .comment-submit-btn:hover {
        background: var(--gradient-gold);
        color: var(--primary-brown);
        transform: translateY(-2px) scale(1.02);
        box-shadow: var(--shadow-strong);
    }

    .comments-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .comment-item {
        background: rgba(255, 255, 255, 0.7);
        padding: 1rem;
        border-radius: 12px;
        border: 2px solid rgba(245, 222, 179, 0.2);
        box-shadow: var(--shadow-soft);
        transition: all 0.3s ease;
    }

    .comment-item:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
        border-color: var(--coffee-gold);
    }

    .comment-header-info {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.7rem;
        padding-bottom: 0.4rem;
        border-bottom: 1px solid rgba(245, 222, 179, 0.3);
    }

    .comment-author {
        font-weight: 700;
        color: var(--primary-brown);
        display: flex;
        align-items: center;
        gap: 0.4rem;
        font-size: 0.9rem;
    }

    .comment-date {
        color: var(--secondary-brown);
        font-size: 0.75rem;
        opacity: 0.8;
    }

    .comment-text {
        color: var(--coffee-dark);
        line-height: 1.6;
        font-size: 0.9rem;
    }

    /* Responsive Design - Improved */
    @media (max-width: 1200px) {
        .product-main-grid {
            max-width: 100%;
            gap: 1.5rem;
            padding: 0.8rem;
        }
    }

    @media (max-width: 900px) {
        .product-main-grid {
            grid-template-columns: 1fr;
            gap: 2rem;
            padding: 1rem;
        }
        
        /* Reorder for mobile - image first, then details */
        .product-info-side {
            order: 2;
        }
        
        .product-image-side {
            order: 1;
        }
        
        .product-title {
            font-size: 1.4rem;
            text-align: center;
        }
        
        .main-image {
            height: 280px;
        }
    }

    @media (max-width: 768px) {
        .product-detail-container {
            padding: 0.8rem;
        }
        
        .product-main-grid {
            gap: 1.5rem;
            padding: 0.5rem;
        }
        
        .product-title {
            font-size: 1.3rem;
        }
        
        .main-image {
            height: 250px;
        }
        
        .options-container {
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        
        .action-buttons {
            grid-template-columns: 1fr;
            gap: 0.8rem;
        }
        
        .product-stats {
            grid-template-columns: 1fr 1fr;
            gap: 0.8rem;
        }

        .comments-section {
            margin-top: 1.5rem;
        }
    }

    @media (max-width: 480px) {
        .product-main-grid {
            gap: 1rem;
        }
        
        .main-image {
            height: 220px;
        }
        
        .product-stats {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            grid-template-columns: 1fr;
        }
    }

    /* Loading Animation */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--gradient-cream);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 1;
        transition: opacity 0.5s ease;
    }

    /* ===== DROPDOWN Z-INDEX FIX ===== */
    /* Create new stacking context for dropdowns */
    .option-group {
        position: relative !important;
        z-index: 1000 !important;
        isolation: isolate !important;
    }
    .custom-select,.profile-dropdown,.dropdown-menu,.dropdown-toggle{
        z-index: 9999999999 !important;
    }

    /* Ensure custom select containers have proper stacking */
    .custom-select {
        position: relative !important;
        z-index: 1001 !important;
        isolation: isolate !important;
    }

    /* Dropdown options with maximum z-index and proper positioning */
    .select-options {
        position: absolute !important;
        z-index: 99999999 !important;
        top: 100% !important;
        left: 0 !important;
        right: 0 !important;
        background: rgba(255, 248, 240, 0.98) !important;
        border: 2px solid var(--coffee-gold) !important;
        border-radius: 10px !important;
        margin-top: 0.2rem !important;
        box-shadow: var(--shadow-strong) !important;
        backdrop-filter: blur(20px) !important;
        opacity: 0 !important;
        visibility: hidden !important;
        transform: translateY(-10px) !important;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
        max-height: 200px !important;
        overflow-y: auto !important;
        /* Force hardware acceleration */
        will-change: transform, opacity !important;
        /* Create new stacking context */
        isolation: isolate !important;
    }

    /* Show state for dropdowns */
    .select-options.show {
        opacity: 1 !important;
        visibility: visible !important;
        pointer-events: auto !important;
        z-index: 2147483647 !important; /* max practical */
    }

    /* Quantity container should have lower z-index */
    .quantity-container {
        position: relative !important;
        z-index: 1 !important;
    }

    /* Ensure all other containers have lower z-index */
    .price-container,
    .action-buttons,
    .product-stats,
    .main-image-container {
        position: relative !important;
        z-index: 1 !important;
    }

    /* Force dropdown options to be on top of everything */
    .option-group .select-options {
        position: absolute !important;
        z-index: 99999999 !important;
        top: 100% !important;
        left: 0 !important;
        right: 0 !important;
    }

    /* Fix for any conflicting Bootstrap or other framework styles */
    .select-options,
    .select-options.show {
        position: absolute !important;
        z-index: 99999999 !important;
        display: block !important;
    }

    /* Additional fixes for stacking context issues */
    .product-main-grid {
        position: relative !important;
        z-index: 10 !important;
    }

    .product-info-side {
        position: relative !important;
        z-index: 100 !important;
    }

    .product-image-side {
        position: relative !important;
        z-index: 1 !important;
    }

    /* Ensure options container has higher stacking order */
    .options-container {
        position: relative !important;
        z-index: 1000 !important;
        /* Prevent overflow clipping of dropdowns */
        overflow: visible !important;
    }

    /* Ensure body doesn't clip dropdowns */
    body {
        overflow-x: hidden;
        overflow-y: auto !important;
    }

    /* Prevent container clipping */
    .product-detail-container,
    .product-main-grid,
    .product-info-side {
        overflow: visible !important;
    }

    /* Ensure dropdowns don't get clipped by parent containers */
    .select-options {
        position: absolute !important;
        z-index: 999999999 !important;
        /* Ensure it doesn't get clipped */
        clip: auto !important;
        -webkit-clip-path: none !important;
        clip-path: none !important;
    }

    .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .coffee-loader {
        width: 80px;
        height: 80px;
        border: 6px solid rgba(245, 222, 179, 0.3);
        border-top: 6px solid var(--secondary-brown);
        border-radius: 50%;
        animation: spin-coffee 2s linear infinite;
    }

    @keyframes spin-coffee {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Animation -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="coffee-loader"></div>
</div>

<div class="product-detail-container">
    <!-- Floating Coffee Beans -->
    <div class="floating-beans">
        <div class="bean"></div>
        <div class="bean"></div>
        <div class="bean"></div>
        <div class="bean"></div>
        <div class="bean"></div>
        <div class="bean"></div>
        <div class="bean"></div>
        <div class="bean"></div>
    </div>

    <div class="product-main-grid">
        <!-- Left Side - Product Information (Features) -->
        <div class="product-info-side">
            <!-- Product Title -->
            <h1 class="product-title">{{ product.name }}</h1>

            <!-- Product Description -->
            <div class="product-description">
                <p>{{ product.description }}</p>
            </div>

            <!-- Price Display -->
            <div class="price-container">
                <div class="price-label">قیمت محصول</div>
                <div class="price-amount" id="displayPrice">
                    <span class="price-currency">تومان</span>
                    <span id="priceValue">{{ product.price|floatformat:0 }}</span>
                </div>
            </div>

            <!-- Product Options -->
            <div class="options-container">
                <!-- Grind Type Selection -->
                <div class="option-group">
                    <div class="option-label">
                        <i class="fas fa-cog"></i>
                        نحوه آسیاب
                    </div>
                    <div class="custom-select">
                        <div class="select-display" id="grindSelect">
                            <span id="grindDisplay">اسیاب نشده</span>
                            <i class="fas fa-chevron-down select-arrow"></i>
                        </div>
                        <div class="select-options" id="grindOptions">
                            <div class="select-option selected" data-value="whole_bean">
                                <span>اسیاب نشده</span>
                            </div>
                            <div class="select-option" data-value="coarse">
                                <span>ترک</span>
                            </div>
                            <div class="select-option" data-value="medium_coarse">
                                <span>موکاپات</span>
                            </div>
                            <div class="select-option" data-value="medium">
                                <span>اسپرسو ساز نیمه صنعتی</span>
                            </div>
                            <div class="select-option" data-value="medium_fine">
                                <span>اسپرسوساز صنعتی</span>
                            </div>
                            <div class="select-option" data-value="fine">
                                <span>اسپرسوساز خانگی</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weight Selection -->
                <div class="option-group">
                    <div class="option-label">
                        <i class="fas fa-weight-hanging"></i>
                        مقدار وزن
                    </div>
                    <div class="custom-select">
                        <div class="select-display" id="weightSelect">
                            <span id="weightDisplay">250 گرم</span>
                            <i class="fas fa-chevron-down select-arrow"></i>
                        </div>
                        <div class="select-options" id="weightOptions">
                            <div class="select-option selected" data-value="250g" data-multiplier="1">
                                <span>250 گرم</span>
                                <span class="option-price">{{ product.price|floatformat:0 }} تومان</span>
                            </div>
                            <div class="select-option" data-value="500g" data-multiplier="2">
                                <span>500 گرم</span>
                                <span class="option-price">{{ product.price|floatformat:0|add:"0" }} تومان</span>
                            </div>
                            <div class="select-option" data-value="1kg" data-multiplier="4">
                                <span>1 کیلوگرم</span>
                                <span class="option-price">{{ product.price|floatformat:0|add:"0" }} تومان</span>
                            </div>
                            <div class="select-option" data-value="5kg" data-multiplier="18">
                                <span>5 کیلوگرم</span>
                                <span class="option-price">{{ product.price|floatformat:0|add:"0" }} تومان</span>
                            </div>
                            <div class="select-option" data-value="10kg" data-multiplier="35">
                                <span>10 کیلوگرم</span>
                                <span class="option-price">{{ product.price|floatformat:0|add:"0" }} تومان</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quantity Selection -->
            <div class="quantity-container">
                <div class="quantity-label">
                    <i class="fas fa-plus-minus"></i>
                    تعداد
                </div>
                <div class="quantity-controls">
                    <button class="quantity-btn" id="decreaseBtn" type="button">
                        <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" class="quantity-input" id="quantityInput" value="1" min="1" max="10">
                    <button class="quantity-btn" id="increaseBtn" type="button">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="add-to-cart-btn" id="addToCartBtn">
                    <i class="fas fa-shopping-cart"></i>
                    افزودن به سبد خرید
                </button>
                
                <button class="social-btn" id="likeBtn" data-product-id="{{ product.id }}">
                    <i class="fas fa-heart"></i>
                    <span>پسندیدن</span>
                </button>
                
                <button class="social-btn" id="favoriteBtn" data-product-id="{{ product.id }}">
                    <i class="fas fa-star"></i>
                    <span>علاقه‌مندی</span>
                </button>
            </div>
        </div>

        <!-- Right Side - Product Image -->
        <div class="product-image-side">
            <div class="main-image-container">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="main-image" loading="lazy" width="800" height="800">
                {% else %}
                    <img src="{% static 'shop/images/default-coffee.jpg' %}" alt="{{ product.name }}" class="main-image" loading="lazy" width="800" height="800">
                {% endif %}
                <div class="image-overlay"></div>
                <div class="steam-effect"></div>
            </div>

            <!-- Product Stats -->
            <div class="product-stats">
                <div class="stat-item">
                    <div class="stat-number">{{ product.stock }}</div>
                    <div class="stat-label">
                        <i class="fas fa-boxes"></i>
                        موجودی
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">4.9</div>
                    <div class="stat-label">
                        <i class="fas fa-star"></i>
                        امتیاز
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ product.created_at|date:"Y" }}</div>
                    <div class="stat-label">
                        <i class="fas fa-calendar"></i>
                        سال تولید
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section">
        <div class="comments-header">
            <h3>
                <i class="fas fa-comments"></i>
                نظرات و دیدگاه‌ها
            </h3>
        </div>
        <div class="comments-container">
            {% if user.is_authenticated %}
                <div class="comment-form">
                    <textarea id="commentText" placeholder="نظر خود را در مورد این محصول بنویسید..."></textarea>
                    <button class="comment-submit-btn" id="submitCommentBtn">
                        <i class="fas fa-paper-plane"></i>
                        ارسال نظر
                    </button>
                </div>
            {% else %}
                <div class="comment-form">
                    <p style="text-align: center; color: var(--primary-brown); margin-bottom: 1rem;">
                        برای ثبت نظر لطفاً <a href="{% url 'login' %}" style="color: var(--secondary-brown); text-decoration: none; font-weight: bold;">وارد شوید</a>
                    </p>
                </div>
            {% endif %}

            <div class="comments-list" id="commentsList">
                {% for comment in product.comments.all %}
                    <div class="comment-item">
                        <div class="comment-header-info">
                            <div class="comment-author">
                                <i class="fas fa-user-circle"></i>
                                {{ comment.user.username }}
                            </div>
                            <div class="comment-date">
                                {{ comment.created_at|date:"d F Y - H:i" }}
                            </div>
                        </div>
                        <div class="comment-text">
                            {{ comment.text }}
                        </div>
                    </div>
                {% empty %}
                    <div class="comment-item" style="text-align: center; color: var(--secondary-brown);">
                        <i class="fas fa-comment-slash" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>هنوز نظری برای این محصول ثبت نشده است. اولین نفری باشید که نظر می‌دهد!</p>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Hide loading overlay
    setTimeout(() => {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }, 1200);

    // Product data
    const basePrice = {{ product.price }};
    const productId = {{ product.id }};
    
    // Weight multipliers - FIXED: 500g = 2x, 1kg = 4x
    const weightMultipliers = {
        '250g': 1,
        '500g': 2,
        '1kg': 4,
        '5kg': 18,
        '10kg': 35
    };

    // Current selections
    let currentGrind = 'whole_bean';
    let currentWeight = '250g';
    let currentQuantity = 1;

    // Initialize dropdowns
    initializeDropdowns();
    initializeQuantityControls();
    initializeActionButtons();
    initializeComments();
    updatePriceDisplay();

    function initializeDropdowns() {
        // Grind type dropdown
        const grindSelect = document.getElementById('grindSelect');
        const grindOptions = document.getElementById('grindOptions');
        const grindDisplay = document.getElementById('grindDisplay');

        grindSelect.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleDropdown(grindSelect, grindOptions);
        });

        grindOptions.addEventListener('click', function(e) {
            const optionEl = e.target.closest('.select-option');
            if (optionEl && grindOptions.contains(optionEl)) {
                const prev = grindOptions.querySelector('.selected');
                if (prev) prev.classList.remove('selected');
                optionEl.classList.add('selected');
                grindDisplay.textContent = optionEl.querySelector('span').textContent;
                currentGrind = optionEl.dataset.value;
                closeDropdown(grindSelect, grindOptions);
            }
        });

        // Weight dropdown
        const weightSelect = document.getElementById('weightSelect');
        const weightOptions = document.getElementById('weightOptions');
        const weightDisplay = document.getElementById('weightDisplay');

        weightSelect.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleDropdown(weightSelect, weightOptions);
        });

        weightOptions.addEventListener('click', function(e) {
            const optionEl = e.target.closest('.select-option');
            if (optionEl && weightOptions.contains(optionEl)) {
                const prev = weightOptions.querySelector('.selected');
                if (prev) prev.classList.remove('selected');
                optionEl.classList.add('selected');
                weightDisplay.textContent = optionEl.querySelector('span').textContent;
                currentWeight = optionEl.dataset.value;
                updatePriceDisplay();
                updateWeightPrices();
                closeDropdown(weightSelect, weightOptions);
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function() {
            closeDropdown(grindSelect, grindOptions);
            closeDropdown(weightSelect, weightOptions);
        });
    }

    function toggleDropdown(select, options) {
        const isOpen = select.classList.contains('open');
        
        // Close all dropdowns first
        document.querySelectorAll('.select-display.open').forEach(dropdown => {
            dropdown.classList.remove('open');
        });
        document.querySelectorAll('.select-options.show').forEach(optionsEl => {
            optionsEl.classList.remove('show');
        });

        if (!isOpen) {
            select.classList.add('open');
            options.classList.add('show');
            
            // Force reflow to ensure proper positioning
            options.offsetHeight;
            
            // Add additional z-index boost for the active dropdown
            options.style.zIndex = '999999999';
            options.style.position = 'absolute';
            
            // Ensure dropdown is properly positioned
            const rect = select.getBoundingClientRect();
            const parentRect = select.closest('.option-group').getBoundingClientRect();
            
            // Force the dropdown to appear above other content
            setTimeout(() => {
                options.style.transform = 'translateY(0)';
                options.style.opacity = '1';
                options.style.visibility = 'visible';
            }, 10);
        }
    }

    function closeDropdown(select, options) {
        select.classList.remove('open');
        options.classList.remove('show');
        
        // Clean up any inline styles
        options.style.zIndex = '';
        options.style.position = '';
        options.style.transform = '';
        options.style.opacity = '';
        options.style.visibility = '';
    }

    function initializeQuantityControls() {
        const decreaseBtn = document.getElementById('decreaseBtn');
        const increaseBtn = document.getElementById('increaseBtn');
        const quantityInput = document.getElementById('quantityInput');

        decreaseBtn.addEventListener('click', function() {
            if (currentQuantity > 1) {
                currentQuantity--;
                quantityInput.value = currentQuantity;
                updatePriceDisplay();
            }
        });

        increaseBtn.addEventListener('click', function() {
            if (currentQuantity < 10) {
                currentQuantity++;
                quantityInput.value = currentQuantity;
                updatePriceDisplay();
            }
        });

        quantityInput.addEventListener('change', function() {
            const value = parseInt(this.value);
            if (value >= 1 && value <= 10) {
                currentQuantity = value;
                updatePriceDisplay();
            } else {
                this.value = currentQuantity;
            }
        });
    }

    function updatePriceDisplay() {
        const multiplier = weightMultipliers[currentWeight];
        const unitPrice = basePrice * multiplier;
        const totalPrice = unitPrice * currentQuantity;
        
        document.getElementById('priceValue').textContent = Math.round(totalPrice).toLocaleString();
    }

    function updateWeightPrices() {
        const weightOptions = document.querySelectorAll('#weightOptions .select-option');
        weightOptions.forEach(option => {
            const multiplier = parseFloat(option.dataset.multiplier);
            const price = Math.round(basePrice * multiplier);
            const priceElement = option.querySelector('.option-price');
            if (priceElement) {
                priceElement.textContent = price.toLocaleString() + ' تومان';
            }
        });
    }

    function initializeActionButtons() {
        // Add to Cart Button
        const addToCartBtn = document.getElementById('addToCartBtn');
        addToCartBtn.addEventListener('click', function() {
            addToCart();
        });

        // Like Button
        const likeBtn = document.getElementById('likeBtn');
        likeBtn.addEventListener('click', function() {
            toggleLike();
        });

        // Favorite Button
        const favoriteBtn = document.getElementById('favoriteBtn');
        favoriteBtn.addEventListener('click', function() {
            toggleFavorite();
        });
    }

    function initializeComments() {
        const submitBtn = document.getElementById('submitCommentBtn');
        if (submitBtn) {
            submitBtn.addEventListener('click', function() {
                submitComment();
            });
        }
    }

    function submitComment() {
        const commentText = document.getElementById('commentText').value.trim();
        const submitBtn = document.getElementById('submitCommentBtn');
        
        if (!commentText) {
            alert('لطفاً نظر خود را بنویسید.');
            return;
        }

        // Show loading state
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال ارسال...';
        submitBtn.disabled = true;

        // Send AJAX request
        fetch(`/shop/product/${productId}/comment/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                text: commentText
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Clear the textarea
                document.getElementById('commentText').value = '';
                
                // Add the new comment to the list
                const commentsList = document.getElementById('commentsList');
                const emptyMessage = commentsList.querySelector('.comment-item:has(.fa-comment-slash)');
                if (emptyMessage) {
                    emptyMessage.remove();
                }
                
                const newComment = document.createElement('div');
                newComment.className = 'comment-item';
                newComment.innerHTML = `
                    <div class="comment-header-info">
                        <div class="comment-author">
                            <i class="fas fa-user-circle"></i>
                            ${data.comment.user}
                        </div>
                        <div class="comment-date">
                            ${data.comment.date}
                        </div>
                    </div>
                    <div class="comment-text">
                        ${data.comment.text}
                    </div>
                `;
                
                commentsList.insertBefore(newComment, commentsList.firstChild);
                
                // Success animation
                submitBtn.innerHTML = '<i class="fas fa-check"></i> ارسال شد!';
                submitBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                
                setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.style.background = '';
                    submitBtn.disabled = false;
                }, 2000);
            } else {
                throw new Error(data.message || 'خطا در ارسال نظر');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> خطا!';
            submitBtn.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
            
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.style.background = '';
                submitBtn.disabled = false;
            }, 2000);
        });
    }

    function addToCart() {
        const addToCartBtn = document.getElementById('addToCartBtn');
        const originalText = addToCartBtn.innerHTML;
        
        // Show loading state
        addToCartBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال افزودن...';
        addToCartBtn.disabled = true;

        // Prepare data
        const cartData = {
            product_id: productId,
            quantity: currentQuantity,
            grind_type: currentGrind,
            weight: currentWeight,
            csrfmiddlewaretoken: document.querySelector('[name=csrfmiddlewaretoken]').value
        };

        // Send AJAX request
        fetch('{% url "add_to_cart" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': cartData.csrfmiddlewaretoken
            },
            body: new URLSearchParams(cartData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Success animation
                addToCartBtn.innerHTML = '<i class="fas fa-check"></i> افزوده شد!';
                addToCartBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                
                // Update cart count if exists
                const cartCount = document.querySelector('.cart-count');
                if (cartCount) {
                    cartCount.textContent = data.cart_count;
                }
                
                setTimeout(() => {
                    addToCartBtn.innerHTML = originalText;
                    addToCartBtn.style.background = '';
                    addToCartBtn.disabled = false;
                }, 2000);
            } else {
                throw new Error(data.message || 'خطا در افزودن به سبد خرید');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addToCartBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> خطا!';
            addToCartBtn.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
            
            setTimeout(() => {
                addToCartBtn.innerHTML = originalText;
                addToCartBtn.style.background = '';
                addToCartBtn.disabled = false;
            }, 2000);
        });
    }

    function toggleLike() {
        const likeBtn = document.getElementById('likeBtn');
        const isLiked = likeBtn.classList.contains('liked');
        
        // Optimistic update
        if (isLiked) {
            likeBtn.classList.remove('liked');
            likeBtn.querySelector('span').textContent = 'پسندیدن';
        } else {
            likeBtn.classList.add('liked');
            likeBtn.querySelector('span').textContent = 'پسندیده شده';
        }

        // Send AJAX request
        fetch(`/shop/product/${productId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Revert on error
            if (isLiked) {
                likeBtn.classList.add('liked');
                likeBtn.querySelector('span').textContent = 'پسندیده شده';
            } else {
                likeBtn.classList.remove('liked');
                likeBtn.querySelector('span').textContent = 'پسندیدن';
            }
        });
    }

    function toggleFavorite() {
        const favoriteBtn = document.getElementById('favoriteBtn');
        const isFavorited = favoriteBtn.classList.contains('favorited');
        
        // Optimistic update
        if (isFavorited) {
            favoriteBtn.classList.remove('favorited');
            favoriteBtn.querySelector('span').textContent = 'علاقه‌مندی';
        } else {
            favoriteBtn.classList.add('favorited');
            favoriteBtn.querySelector('span').textContent = 'علاقه‌مند';
        }

        // Send AJAX request
        fetch(`/shop/product/${productId}/favorite/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Revert on error
            if (isFavorited) {
                favoriteBtn.classList.add('favorited');
                favoriteBtn.querySelector('span').textContent = 'علاقه‌مند';
            } else {
                favoriteBtn.classList.remove('favorited');
                favoriteBtn.querySelector('span').textContent = 'علاقه‌مندی';
            }
        });
    }

    // Initialize weight prices
    updateWeightPrices();

    // GSAP Animations
    if (typeof gsap !== 'undefined') {
        // Animate elements on scroll
        gsap.registerPlugin(ScrollTrigger);
        
        gsap.fromTo('.product-info-side', {
            x: -100,
            opacity: 0
        }, {
            x: 0,
            opacity: 1,
            duration: 1,
            ease: 'power2.out'
        });

        gsap.fromTo('.product-image-side', {
            x: 100,
            opacity: 0
        }, {
            x: 0,
            opacity: 1,
            duration: 1,
            ease: 'power2.out',
            delay: 0.2
        });
    }
});
</script>

{% csrf_token %}
{% endblock %}