{% extends 'shop/base.html' %}
{% load static %}

{% block title %}{{ product.name }} - Premium Coffee Experience{% endblock %}

{% block head %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js" defer></script>
{% endblock %}

{% block extra_css %}
<style>
    :root {
        /* Coffee Theme Color Palette - Matching Homepage */
        --primary-brown: #4B2E2B;
        --secondary-brown: #7B3F00;
        --accent-brown: #C97C5D;
        --coffee-cream: #FFF8F0;
        --coffee-gold: #F5DEB3;
        --coffee-light: #D2B48C;
        --coffee-dark: #2C1810;
        --coffee-beige: #F3E9DC;
        
        /* Gradients from Homepage */
        --gradient-primary: linear-gradient(135deg, #4B2E2B 0%, #7B3F00 50%, #C97C5D 100%);
        --gradient-gold: linear-gradient(135deg, #F5DEB3 0%, #D2B48C 50%, #8B4513 100%);
        --gradient-cream: linear-gradient(135deg, #FFF8F0 0%, #F3E9DC 100%);
        --gradient-accent: linear-gradient(135deg, #4B2E2B 0%, #7B3F00 100%);
        --gradient-magical: linear-gradient(45deg, #F5DEB3, #D2B48C, #8B4513, #D2B48C, #F5DEB3);
        
        /* Shadows */
        --shadow-soft: 0 8px 25px rgba(75, 46, 43, 0.3);
        --shadow-medium: 0 15px 35px rgba(75, 46, 43, 0.4);
        --shadow-strong: 0 20px 50px rgba(75, 46, 43, 0.5);
        --shadow-glow: 0 0 30px rgba(245, 222, 179, 0.5);
        --shadow-magical: 0 0 40px rgba(245, 222, 179, 0.8);
    }

    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: 'Vazirmatn', sans-serif;
        background: var(--gradient-cream);
        color: var(--coffee-dark);
        line-height: 1.6;
        overflow-x: hidden;
    }

    /* Sensational Background with Floating Elements */
    .product-detail-container {
        min-height: 100vh;
        padding: 2rem;
        background: var(--gradient-cream);
        position: relative;
        overflow: hidden;
    }

    /* Coffee Bean Floating Animation - From Homepage */
    .floating-beans {
        position: absolute;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1;
        opacity: 0.4;
    }

    .bean {
        position: absolute;
        width: 15px;
        height: 15px;
        background: var(--gradient-gold);
        border-radius: 50%;
        animation: floatBean 20s infinite linear;
        box-shadow: var(--shadow-glow);
    }

    .bean:nth-child(1) { left: 5%; animation-delay: 0s; }
    .bean:nth-child(2) { left: 15%; animation-delay: 4s; }
    .bean:nth-child(3) { left: 30%; animation-delay: 8s; }
    .bean:nth-child(4) { left: 45%; animation-delay: 12s; }
    .bean:nth-child(5) { left: 60%; animation-delay: 16s; }
    .bean:nth-child(6) { left: 75%; animation-delay: 2s; }
    .bean:nth-child(7) { left: 85%; animation-delay: 6s; }
    .bean:nth-child(8) { left: 95%; animation-delay: 10s; }

    @keyframes floatBean {
        0% {
            transform: translateY(100vh) rotate(0deg) scale(0.5);
            opacity: 0;
        }
        10% {
            opacity: 0.8;
            transform: translateY(90vh) rotate(36deg) scale(1);
        }
        90% {
            opacity: 0.8;
            transform: translateY(10vh) rotate(324deg) scale(1);
        }
        100% {
            transform: translateY(-10vh) rotate(360deg) scale(0.5);
            opacity: 0;
        }
    }

    /* Main Product Grid */
    .product-main-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4rem;
        max-width: 1400px;
        margin: 0 auto;
        position: relative;
        z-index: 10;
        padding: 2rem 0;
    }

    /* Left Side - Product Information */
    .product-info-side {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        animation: slideInLeft 1s ease-out;
    }

    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-50px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* Product Title with Magical Effect */
    .product-title {
        font-size: 3rem;
        font-weight: 900;
        background: var(--gradient-magical);
        background-size: 400% 400%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: gradient-shift 4s ease-in-out infinite, float-title 6s ease-in-out infinite;
        text-shadow: 0 0 30px rgba(245, 222, 179, 0.3);
        margin-bottom: 1rem;
        line-height: 1.2;
    }

    @keyframes gradient-shift {
        0%, 100% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
    }

    @keyframes float-title {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-5px); }
    }

    /* Product Description */
    .product-description {
        background: rgba(255, 248, 240, 0.9);
        padding: 2rem;
        border-radius: 25px;
        border: 2px solid rgba(245, 222, 179, 0.3);
        box-shadow: var(--shadow-soft);
        font-size: 1.1rem;
        line-height: 1.8;
        color: var(--primary-brown);
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
    }

    .product-description:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-medium);
        border-color: var(--coffee-gold);
    }

    /* Price Display with Animation */
    .price-container {
        background: var(--gradient-accent);
        padding: 2rem;
        border-radius: 25px;
        text-align: center;
        box-shadow: var(--shadow-medium);
        position: relative;
        overflow: hidden;
        animation: pulse-glow 3s ease-in-out infinite;
    }

    @keyframes pulse-glow {
        0%, 100% { 
            box-shadow: var(--shadow-medium);
        }
        50% { 
            box-shadow: var(--shadow-strong), var(--shadow-magical);
        }
    }

    .price-label {
        color: var(--coffee-cream);
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        opacity: 0.9;
    }

    .price-amount {
        color: var(--coffee-cream);
        font-size: 2.5rem;
        font-weight: 900;
        text-shadow: 0 0 20px rgba(255, 248, 240, 0.5);
    }

    .price-currency {
        font-size: 1.5rem;
        margin-right: 0.5rem;
    }

    /* Sensational Dropdown Styles */
    .options-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        margin: 2rem 0;
    }

    .option-group {
        background: rgba(255, 248, 240, 0.95);
        border-radius: 20px;
        padding: 1.5rem;
        border: 2px solid rgba(245, 222, 179, 0.3);
        box-shadow: var(--shadow-soft);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        backdrop-filter: blur(10px);
    }

    .option-group:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: var(--shadow-medium), var(--shadow-glow);
        border-color: var(--coffee-gold);
    }

    .option-label {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary-brown);
        margin-bottom: 1rem;
    }

    .option-label i {
        font-size: 1.3rem;
        color: var(--secondary-brown);
    }

    /* Custom Dropdown Styling */
    .custom-select {
        position: relative;
        width: 100%;
    }

    .select-display {
        background: var(--gradient-cream);
        border: 2px solid rgba(75, 46, 43, 0.2);
        border-radius: 15px;
        padding: 1rem 1.5rem;
        font-size: 1rem;
        font-weight: 600;
        color: var(--primary-brown);
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: var(--shadow-soft);
        position: relative;
        overflow: hidden;
    }

    .select-display::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(245, 222, 179, 0.3), transparent);
        transition: left 0.5s ease;
    }

    .select-display:hover::before {
        left: 100%;
    }

    .select-display:hover {
        border-color: var(--secondary-brown);
        transform: translateY(-2px);
        box-shadow: var(--shadow-medium);
    }

    .select-display.open {
        border-color: var(--secondary-brown);
        box-shadow: var(--shadow-glow);
    }

    .select-arrow {
        transition: transform 0.3s ease;
        color: var(--secondary-brown);
        font-size: 1.2rem;
    }

    .select-display.open .select-arrow {
        transform: rotate(180deg);
    }

    .select-options {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: rgba(255, 248, 240, 0.98);
        border: 2px solid var(--coffee-gold);
        border-radius: 15px;
        margin-top: 0.5rem;
        box-shadow: var(--shadow-strong);
        backdrop-filter: blur(20px);
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        max-height: 300px;
        overflow-y: auto;
    }

    .select-options.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
    }

    .select-option {
        padding: 1rem 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 1px solid rgba(245, 222, 179, 0.2);
        color: var(--primary-brown);
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .select-option:last-child {
        border-bottom: none;
    }

    .select-option:hover {
        background: var(--gradient-gold);
        color: var(--primary-brown);
        transform: translateX(5px);
    }

    .select-option.selected {
        background: var(--gradient-accent);
        color: var(--coffee-cream);
        font-weight: 700;
    }

    .option-price {
        font-size: 0.9rem;
        font-weight: 700;
        color: var(--secondary-brown);
    }

    /* Quantity Selector */
    .quantity-container {
        background: rgba(255, 248, 240, 0.95);
        border-radius: 20px;
        padding: 1.5rem;
        border: 2px solid rgba(245, 222, 179, 0.3);
        box-shadow: var(--shadow-soft);
        text-align: center;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
    }

    .quantity-container:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-medium);
        border-color: var(--coffee-gold);
    }

    .quantity-label {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 1.1rem;
        font-weight: 700;
        color: var(--primary-brown);
        margin-bottom: 1rem;
    }

    .quantity-controls {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        background: var(--gradient-cream);
        border-radius: 50px;
        padding: 0.5rem;
        box-shadow: inset 0 2px 10px rgba(75, 46, 43, 0.1);
    }

    .quantity-btn {
        width: 50px;
        height: 50px;
        border: none;
        background: var(--gradient-accent);
        color: var(--coffee-cream);
        border-radius: 50%;
        font-size: 1.5rem;
        font-weight: 900;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: var(--shadow-soft);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .quantity-btn:hover {
        background: var(--gradient-gold);
        color: var(--primary-brown);
        transform: scale(1.1);
        box-shadow: var(--shadow-medium);
    }

    .quantity-btn:active {
        transform: scale(0.95);
    }

    .quantity-input {
        width: 80px;
        height: 50px;
        border: 2px solid rgba(75, 46, 43, 0.2);
        border-radius: 15px;
        text-align: center;
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary-brown);
        background: var(--coffee-cream);
        box-shadow: inset 0 2px 5px rgba(75, 46, 43, 0.1);
    }

    .quantity-input:focus {
        outline: none;
        border-color: var(--secondary-brown);
        box-shadow: var(--shadow-glow);
    }

    /* Sensational Action Buttons */
    .action-buttons {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 1.5rem;
        margin: 3rem 0;
    }

    /* Add to Cart Button - Hero Style */
    .add-to-cart-btn {
        background: var(--gradient-accent);
        color: var(--coffee-cream);
        border: none;
        padding: 1.5rem 2rem;
        border-radius: 25px;
        font-size: 1.3rem;
        font-weight: 900;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: var(--shadow-medium);
        position: relative;
        overflow: hidden;
        text-transform: uppercase;
        letter-spacing: 1px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        animation: cart-pulse 2s ease-in-out infinite;
    }

    @keyframes cart-pulse {
        0%, 100% { 
            box-shadow: var(--shadow-medium);
        }
        50% { 
            box-shadow: var(--shadow-strong), var(--shadow-magical);
        }
    }

    .add-to-cart-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 248, 240, 0.3), transparent);
        transition: left 0.6s ease;
    }

    .add-to-cart-btn:hover::before {
        left: 100%;
    }

    .add-to-cart-btn:hover {
        background: var(--gradient-gold);
        color: var(--primary-brown);
        transform: translateY(-5px) scale(1.05);
        box-shadow: var(--shadow-strong), var(--shadow-magical);
    }

    .add-to-cart-btn:active {
        transform: translateY(-2px) scale(1.02);
    }

    .add-to-cart-btn i {
        font-size: 1.5rem;
        animation: cart-bounce 1s ease-in-out infinite;
    }

    @keyframes cart-bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-3px); }
    }

    /* Like and Favorite Buttons */
    .social-btn {
        background: rgba(255, 248, 240, 0.9);
        border: 2px solid rgba(245, 222, 179, 0.3);
        color: var(--primary-brown);
        padding: 1.5rem;
        border-radius: 20px;
        font-size: 1.1rem;
        font-weight: 700;
        cursor: pointer;
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        box-shadow: var(--shadow-soft);
        position: relative;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        backdrop-filter: blur(10px);
    }

    .social-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(245, 222, 179, 0.2), transparent);
        transition: left 0.5s ease;
    }

    .social-btn:hover::before {
        left: 100%;
    }

    .social-btn:hover {
        background: var(--gradient-gold);
        border-color: var(--secondary-brown);
        transform: translateY(-5px) scale(1.05);
        box-shadow: var(--shadow-medium), var(--shadow-glow);
    }

    .social-btn.liked {
        background: linear-gradient(135deg, #FF6B6B, #FF8E8E);
        color: white;
        border-color: #FF6B6B;
        animation: heart-beat 1.5s ease-in-out infinite;
    }

    @keyframes heart-beat {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .social-btn.favorited {
        background: linear-gradient(135deg, #FFD700, #FFA500);
        color: var(--coffee-dark);
        border-color: #FFD700;
        animation: star-twinkle 2s ease-in-out infinite;
    }

    @keyframes star-twinkle {
        0%, 100% { 
            box-shadow: var(--shadow-soft);
        }
        50% { 
            box-shadow: var(--shadow-medium), 0 0 30px rgba(255, 215, 0, 0.8);
        }
    }

    /* Right Side - Product Image */
    .product-image-side {
        display: flex;
        flex-direction: column;
        gap: 2rem;
        animation: slideInRight 1s ease-out;
    }

    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(50px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    /* Main Image Container with Magical Effects */
    .main-image-container {
        position: relative;
        border-radius: 25px;
        overflow: hidden;
        background: var(--gradient-cream);
        border: 3px solid rgba(245, 222, 179, 0.3);
        box-shadow: var(--shadow-medium);
        transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        cursor: pointer;
    }

    .main-image-container:hover {
        transform: translateY(-10px) scale(1.02);
        box-shadow: var(--shadow-strong), var(--shadow-magical);
        border-color: var(--coffee-gold);
    }

    .main-image {
        width: 100%;
        height: 600px;
        object-fit: cover;
        transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    .main-image:hover {
        transform: scale(1.1);
    }

    /* Magical Image Overlay */
    .image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: 
            radial-gradient(circle at 30% 30%, rgba(245, 222, 179, 0.2) 0%, transparent 50%),
            radial-gradient(circle at 70% 70%, rgba(210, 180, 140, 0.2) 0%, transparent 50%),
            linear-gradient(45deg, transparent 30%, rgba(245, 222, 179, 0.1) 70%);
        opacity: 0;
        transition: opacity 0.5s ease;
        pointer-events: none;
    }

    .main-image-container:hover .image-overlay {
        opacity: 1;
    }

    /* Steam Effect on Image */
    .steam-effect {
        position: absolute;
        top: 20%;
        left: 50%;
        transform: translateX(-50%);
        width: 100px;
        height: 200px;
        background: linear-gradient(180deg, transparent, rgba(245, 222, 179, 0.3), transparent);
        filter: blur(15px);
        opacity: 0;
        animation: steam-rise-image 4s ease-in-out infinite;
        pointer-events: none;
    }

    @keyframes steam-rise-image {
        0% {
            opacity: 0;
            transform: translateX(-50%) translateY(0) scaleY(0.5);
        }
        50% {
            opacity: 0.8;
            transform: translateX(-50%) translateY(-50px) scaleY(1.5) scaleX(1.2);
        }
        100% {
            opacity: 0;
            transform: translateX(-50%) translateY(-100px) scaleY(2) scaleX(1.5);
        }
    }

    .main-image-container:hover .steam-effect {
        opacity: 1;
    }

    /* Product Stats with Beautiful Animation */
    .product-stats {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
        margin-top: 2rem;
    }

    .stat-item {
        text-align: center;
        background: rgba(255, 248, 240, 0.95);
        padding: 2rem 1rem;
        border-radius: 25px;
        border: 2px solid rgba(245, 222, 179, 0.3);
        box-shadow: var(--shadow-soft);
        transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .stat-item::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: conic-gradient(transparent, rgba(245, 222, 179, 0.1), transparent);
        animation: rotate-bg 4s linear infinite;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .stat-item:hover::before {
        opacity: 1;
    }

    @keyframes rotate-bg {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .stat-item:hover {
        transform: translateY(-8px) scale(1.05);
        box-shadow: var(--shadow-medium), var(--shadow-glow);
        border-color: var(--coffee-gold);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 900;
        background: var(--gradient-accent);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
        position: relative;
        z-index: 2;
    }

    .stat-label {
        font-size: 1rem;
        color: var(--primary-brown);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-weight: 600;
        position: relative;
        z-index: 2;
    }

    .stat-label i {
        font-size: 1.2rem;
        color: var(--secondary-brown);
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .product-main-grid {
            grid-template-columns: 1fr;
            gap: 3rem;
            padding: 1rem;
        }
        
        .product-title {
            font-size: 2.5rem;
        }
        
        .options-container {
            grid-template-columns: 1fr;
        }
        
        .action-buttons {
            grid-template-columns: 1fr;
        }
        
        .product-stats {
            grid-template-columns: 1fr 1fr;
        }
    }

    @media (max-width: 768px) {
        .product-detail-container {
            padding: 1rem;
        }
        
        .product-title {
            font-size: 2rem;
        }
        
        .main-image {
            height: 400px;
        }
        
        .product-stats {
            grid-template-columns: 1fr;
        }
    }

    /* Loading Animation */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--gradient-cream);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        opacity: 1;
        transition: opacity 0.5s ease;
    }

    .loading-overlay.hidden {
        opacity: 0;
        pointer-events: none;
    }

    .coffee-loader {
        width: 100px;
        height: 100px;
        border: 8px solid rgba(245, 222, 179, 0.3);
        border-top: 8px solid var(--secondary-brown);
        border-radius: 50%;
        animation: spin-coffee 2s linear infinite;
    }

    @keyframes spin-coffee {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>
{% endblock %}

{% block content %}
<!-- Loading Animation -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="coffee-loader"></div>
</div>

<div class="product-detail-container">
    <!-- Floating Coffee Beans -->
    <div class="floating-beans">
        <div class="bean"></div>
        <div class="bean"></div>
        <div class="bean"></div>
        <div class="bean"></div>
        <div class="bean"></div>
        <div class="bean"></div>
        <div class="bean"></div>
        <div class="bean"></div>
    </div>

    <div class="product-main-grid">
        <!-- Left Side - Product Information -->
        <div class="product-info-side">
            <!-- Product Title -->
            <h1 class="product-title">{{ product.name }}</h1>

            <!-- Product Description -->
            <div class="product-description">
                <p>{{ product.description }}</p>
            </div>

            <!-- Price Display -->
            <div class="price-container">
                <div class="price-label">قیمت محصول</div>
                <div class="price-amount" id="displayPrice">
                    <span class="price-currency">تومان</span>
                    <span id="priceValue">{{ product.price|floatformat:0 }}</span>
                </div>
            </div>

            <!-- Product Options -->
            <div class="options-container">
                <!-- Grind Type Selection -->
                <div class="option-group">
                    <div class="option-label">
                        <i class="fas fa-cog"></i>
                        نحوه آسیاب
                    </div>
                    <div class="custom-select">
                        <div class="select-display" id="grindSelect">
                            <span id="grindDisplay">دانه کامل</span>
                            <i class="fas fa-chevron-down select-arrow"></i>
                        </div>
                        <div class="select-options" id="grindOptions">
                            <div class="select-option selected" data-value="whole_bean">
                                <span>دانه کامل</span>
                            </div>
                            <div class="select-option" data-value="coarse">
                                <span>درشت (فرنچ پرس)</span>
                            </div>
                            <div class="select-option" data-value="medium_coarse">
                                <span>متوسط درشت (کمکس)</span>
                            </div>
                            <div class="select-option" data-value="medium">
                                <span>متوسط (دریپ)</span>
                            </div>
                            <div class="select-option" data-value="medium_fine">
                                <span>متوسط ریز (اروپرس)</span>
                            </div>
                            <div class="select-option" data-value="fine">
                                <span>ریز (اسپرسو)</span>
                            </div>
                            <div class="select-option" data-value="extra_fine">
                                <span>فوق ریز (ترک)</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Weight Selection -->
                <div class="option-group">
                    <div class="option-label">
                        <i class="fas fa-weight-hanging"></i>
                        مقدار وزن
                    </div>
                    <div class="custom-select">
                        <div class="select-display" id="weightSelect">
                            <span id="weightDisplay">250 گرم</span>
                            <i class="fas fa-chevron-down select-arrow"></i>
                        </div>
                        <div class="select-options" id="weightOptions">
                            <div class="select-option selected" data-value="250g" data-multiplier="1">
                                <span>250 گرم</span>
                                <span class="option-price">{{ product.price|floatformat:0 }} تومان</span>
                            </div>
                            <div class="select-option" data-value="500g" data-multiplier="1.8">
                                <span>500 گرم</span>
                                <span class="option-price">{{ product.price|floatformat:0|add:"0" }} تومان</span>
                            </div>
                            <div class="select-option" data-value="1kg" data-multiplier="3.5">
                                <span>1 کیلوگرم</span>
                                <span class="option-price">{{ product.price|floatformat:0|add:"0" }} تومان</span>
                            </div>
                            <div class="select-option" data-value="5kg" data-multiplier="16">
                                <span>5 کیلوگرم</span>
                                <span class="option-price">{{ product.price|floatformat:0|add:"0" }} تومان</span>
                            </div>
                            <div class="select-option" data-value="10kg" data-multiplier="30">
                                <span>10 کیلوگرم</span>
                                <span class="option-price">{{ product.price|floatformat:0|add:"0" }} تومان</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quantity Selection -->
            <div class="quantity-container">
                <div class="quantity-label">
                    <i class="fas fa-plus-minus"></i>
                    تعداد
                </div>
                <div class="quantity-controls">
                    <button class="quantity-btn" id="decreaseBtn" type="button">
                        <i class="fas fa-minus"></i>
                    </button>
                    <input type="number" class="quantity-input" id="quantityInput" value="1" min="1" max="10">
                    <button class="quantity-btn" id="increaseBtn" type="button">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <button class="add-to-cart-btn" id="addToCartBtn">
                    <i class="fas fa-shopping-cart"></i>
                    افزودن به سبد خرید
                </button>
                
                <button class="social-btn" id="likeBtn" data-product-id="{{ product.id }}">
                    <i class="fas fa-heart"></i>
                    <span>پسندیدن</span>
                </button>
                
                <button class="social-btn" id="favoriteBtn" data-product-id="{{ product.id }}">
                    <i class="fas fa-star"></i>
                    <span>علاقه‌مندی</span>
                </button>
            </div>
        </div>

        <!-- Right Side - Product Image -->
        <div class="product-image-side">
            <div class="main-image-container">
                {% if product.image %}
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="main-image">
                {% else %}
                    <img src="{% static 'shop/images/default-coffee.jpg' %}" alt="{{ product.name }}" class="main-image">
                {% endif %}
                <div class="image-overlay"></div>
                <div class="steam-effect"></div>
            </div>

            <!-- Product Stats -->
            <div class="product-stats">
                <div class="stat-item">
                    <div class="stat-number">{{ product.stock }}</div>
                    <div class="stat-label">
                        <i class="fas fa-boxes"></i>
                        موجودی
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">4.9</div>
                    <div class="stat-label">
                        <i class="fas fa-star"></i>
                        امتیاز
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">{{ product.created_at|date:"Y" }}</div>
                    <div class="stat-label">
                        <i class="fas fa-calendar"></i>
                        سال تولید
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Hide loading overlay
    setTimeout(() => {
        document.getElementById('loadingOverlay').classList.add('hidden');
    }, 1500);

    // Product data
    const basePrice = {{ product.price }};
    const productId = {{ product.id }};
    
    // Weight multipliers
    const weightMultipliers = {
        '250g': 1,
        '500g': 1.8,
        '1kg': 3.5,
        '5kg': 16,
        '10kg': 30
    };

    // Current selections
    let currentGrind = 'whole_bean';
    let currentWeight = '250g';
    let currentQuantity = 1;

    // Initialize dropdowns
    initializeDropdowns();
    initializeQuantityControls();
    initializeActionButtons();
    updatePriceDisplay();

    function initializeDropdowns() {
        // Grind type dropdown
        const grindSelect = document.getElementById('grindSelect');
        const grindOptions = document.getElementById('grindOptions');
        const grindDisplay = document.getElementById('grindDisplay');

        grindSelect.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleDropdown(grindSelect, grindOptions);
        });

        grindOptions.addEventListener('click', function(e) {
            if (e.target.classList.contains('select-option')) {
                // Remove previous selection
                grindOptions.querySelector('.selected').classList.remove('selected');
                // Add new selection
                e.target.classList.add('selected');
                // Update display
                grindDisplay.textContent = e.target.querySelector('span').textContent;
                currentGrind = e.target.dataset.value;
                // Close dropdown
                closeDropdown(grindSelect, grindOptions);
            }
        });

        // Weight dropdown
        const weightSelect = document.getElementById('weightSelect');
        const weightOptions = document.getElementById('weightOptions');
        const weightDisplay = document.getElementById('weightDisplay');

        weightSelect.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleDropdown(weightSelect, weightOptions);
        });

        weightOptions.addEventListener('click', function(e) {
            if (e.target.classList.contains('select-option')) {
                // Remove previous selection
                weightOptions.querySelector('.selected').classList.remove('selected');
                // Add new selection
                e.target.classList.add('selected');
                // Update display
                weightDisplay.textContent = e.target.querySelector('span').textContent;
                currentWeight = e.target.dataset.value;
                // Update price
                updatePriceDisplay();
                updateWeightPrices();
                // Close dropdown
                closeDropdown(weightSelect, weightOptions);
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function() {
            closeDropdown(grindSelect, grindOptions);
            closeDropdown(weightSelect, weightOptions);
        });
    }

    function toggleDropdown(select, options) {
        const isOpen = select.classList.contains('open');
        
        // Close all dropdowns first
        document.querySelectorAll('.select-display.open').forEach(dropdown => {
            dropdown.classList.remove('open');
        });
        document.querySelectorAll('.select-options.show').forEach(options => {
            options.classList.remove('show');
        });

        if (!isOpen) {
            select.classList.add('open');
            options.classList.add('show');
        }
    }

    function closeDropdown(select, options) {
        select.classList.remove('open');
        options.classList.remove('show');
    }

    function initializeQuantityControls() {
        const decreaseBtn = document.getElementById('decreaseBtn');
        const increaseBtn = document.getElementById('increaseBtn');
        const quantityInput = document.getElementById('quantityInput');

        decreaseBtn.addEventListener('click', function() {
            if (currentQuantity > 1) {
                currentQuantity--;
                quantityInput.value = currentQuantity;
                updatePriceDisplay();
            }
        });

        increaseBtn.addEventListener('click', function() {
            if (currentQuantity < 10) {
                currentQuantity++;
                quantityInput.value = currentQuantity;
                updatePriceDisplay();
            }
        });

        quantityInput.addEventListener('change', function() {
            const value = parseInt(this.value);
            if (value >= 1 && value <= 10) {
                currentQuantity = value;
                updatePriceDisplay();
            } else {
                this.value = currentQuantity;
            }
        });
    }

    function updatePriceDisplay() {
        const multiplier = weightMultipliers[currentWeight];
        const unitPrice = basePrice * multiplier;
        const totalPrice = unitPrice * currentQuantity;
        
        document.getElementById('priceValue').textContent = Math.round(totalPrice).toLocaleString();
    }

    function updateWeightPrices() {
        const weightOptions = document.querySelectorAll('#weightOptions .select-option');
        weightOptions.forEach(option => {
            const multiplier = parseFloat(option.dataset.multiplier);
            const price = Math.round(basePrice * multiplier);
            const priceElement = option.querySelector('.option-price');
            if (priceElement) {
                priceElement.textContent = price.toLocaleString() + ' تومان';
            }
        });
    }

    function initializeActionButtons() {
        // Add to Cart Button
        const addToCartBtn = document.getElementById('addToCartBtn');
        addToCartBtn.addEventListener('click', function() {
            addToCart();
        });

        // Like Button
        const likeBtn = document.getElementById('likeBtn');
        likeBtn.addEventListener('click', function() {
            toggleLike();
        });

        // Favorite Button
        const favoriteBtn = document.getElementById('favoriteBtn');
        favoriteBtn.addEventListener('click', function() {
            toggleFavorite();
        });
    }

    function addToCart() {
        const addToCartBtn = document.getElementById('addToCartBtn');
        const originalText = addToCartBtn.innerHTML;
        
        // Show loading state
        addToCartBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> در حال افزودن...';
        addToCartBtn.disabled = true;

        // Prepare data
        const cartData = {
            product_id: productId,
            quantity: currentQuantity,
            grind_type: currentGrind,
            weight: currentWeight,
            csrfmiddlewaretoken: document.querySelector('[name=csrfmiddlewaretoken]').value
        };

        // Send AJAX request
        fetch('{% url "shop:add_to_cart" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': cartData.csrfmiddlewaretoken
            },
            body: new URLSearchParams(cartData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Success animation
                addToCartBtn.innerHTML = '<i class="fas fa-check"></i> افزوده شد!';
                addToCartBtn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
                
                // Update cart count if exists
                const cartCount = document.querySelector('.cart-count');
                if (cartCount) {
                    cartCount.textContent = data.cart_count;
                }
                
                setTimeout(() => {
                    addToCartBtn.innerHTML = originalText;
                    addToCartBtn.style.background = '';
                    addToCartBtn.disabled = false;
                }, 2000);
            } else {
                throw new Error(data.message || 'خطا در افزودن به سبد خرید');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addToCartBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> خطا!';
            addToCartBtn.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
            
            setTimeout(() => {
                addToCartBtn.innerHTML = originalText;
                addToCartBtn.style.background = '';
                addToCartBtn.disabled = false;
            }, 2000);
        });
    }

    function toggleLike() {
        const likeBtn = document.getElementById('likeBtn');
        const isLiked = likeBtn.classList.contains('liked');
        
        // Optimistic update
        if (isLiked) {
            likeBtn.classList.remove('liked');
            likeBtn.querySelector('span').textContent = 'پسندیدن';
        } else {
            likeBtn.classList.add('liked');
            likeBtn.querySelector('span').textContent = 'پسندیده شده';
        }

        // Send AJAX request
        fetch(`/shop/product/${productId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Revert on error
            if (isLiked) {
                likeBtn.classList.add('liked');
                likeBtn.querySelector('span').textContent = 'پسندیده شده';
            } else {
                likeBtn.classList.remove('liked');
                likeBtn.querySelector('span').textContent = 'پسندیدن';
            }
        });
    }

    function toggleFavorite() {
        const favoriteBtn = document.getElementById('favoriteBtn');
        const isFavorited = favoriteBtn.classList.contains('favorited');
        
        // Optimistic update
        if (isFavorited) {
            favoriteBtn.classList.remove('favorited');
            favoriteBtn.querySelector('span').textContent = 'علاقه‌مندی';
        } else {
            favoriteBtn.classList.add('favorited');
            favoriteBtn.querySelector('span').textContent = 'علاقه‌مند';
        }

        // Send AJAX request
        fetch(`/shop/product/${productId}/favorite/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // Revert on error
            if (isFavorited) {
                favoriteBtn.classList.add('favorited');
                favoriteBtn.querySelector('span').textContent = 'علاقه‌مند';
            } else {
                favoriteBtn.classList.remove('favorited');
                favoriteBtn.querySelector('span').textContent = 'علاقه‌مندی';
            }
        });
    }

    // Initialize weight prices
    updateWeightPrices();

    // GSAP Animations
    if (typeof gsap !== 'undefined') {
        // Animate elements on scroll
        gsap.registerPlugin(ScrollTrigger);
        
        gsap.fromTo('.product-info-side', {
            x: -100,
            opacity: 0
        }, {
            x: 0,
            opacity: 1,
            duration: 1,
            ease: 'power2.out'
        });

        gsap.fromTo('.product-image-side', {
            x: 100,
            opacity: 0
        }, {
            x: 0,
            opacity: 1,
            duration: 1,
            ease: 'power2.out',
            delay: 0.2
        });
    }
});
</script>

{% csrf_token %}
{% endblock %}